CREATE DATABASE ManageSQLStudent
go
use ManageSQLStudent

go
CREATE TABLE SINHVIEN(
MSSV VARCHAR(20) Primary Key not null,
TENSV nvarchar(150),
SODT nvarchar(10),
LOP nvarchar(30),
DIACHI nvarchar(100)
);
GO

INSERT INTO SINHVIEN (MSSV, TENSV, DIACHI, LOP, SODT) VALUES 
('97TH01', N'Nguyễn Văn An', '12 NTMK', '97TH01', '9688543'),
('97TH02', N'Lý An', '13/4 LCT', '97TH01', '8454433'),
('97TH03', N'Đinh Thúy Vân', '20 Pastuer', '97TH01', '8455789'),
('97TH04', N'Trần Văn Ngọc', '54/12 LHP', '97TH02', '8149023'),
('97TH05', N'Hà Khánh Ly', '12 HBT', '97TH02', '9851623');

GO
CREATE TABLE DETAI(
MSDT VARCHAR(20)  Primary Key not null,
TENDT nvarchar(150)
);
GO
INSERT INTO DETAI (MSDT, TENDT) VALUES 
('97001', N'Quản lý thư viện'),
('97002', N'Nhận dạng vân tay'),
('97003', N'Bán đấu giá trên mạng'),
('97004', N'Quản lý siêu thị'),
('97005', N'Xử lý ảnh');

CREATE TABLE SV_DETAI (
    MSSV VARCHAR(20),
    MSDT VARCHAR(20),
    FOREIGN KEY (MSSV) REFERENCES SINHVIEN(MSSV),
    FOREIGN KEY (MSDT) REFERENCES DETAI(MSDT)
);
GO
INSERT INTO SV_DETAI (MSSV, MSDT) VALUES 
('97TH01', '97004'),
('97TH02', '97005'),
('97TH03', '97001'),
('97TH04', '97002'),
('97TH05', '97003');

GO
CREATE TABLE GIAOVIEN (
    MSGV INT PRIMARY KEY,
    TENGV VARCHAR(100),
    DIACHI VARCHAR(100),
    SODT VARCHAR(15),
    MSHHAM INT,
    NAMHH INT
);

INSERT INTO GIAOVIEN (MSGV, TENGV, DIACHI, SODT, MSHHAM, NAMHH) VALUES
(1, N'Trần Lan', '11 NVT', '8751515', 1, 1996),
(2, N'Nguyễn Văn A', '23/5 LQĐ', '8515186', 1, 1996),
(3, N'Lê Trung', '4 TC', '8235464', 1, 1996),
(4, N'Nguyễn Bảo Thy', '78 NTMK', '8775588', 2, 1997),
(5, N'Chu Hòai Ân', '71/4 TL', '8997859', 2, 1997),
(6, N'Nguyễn Ngọc An', '11 HBT', '8457689', 2, 1997);

CREATE TABLE HOCVI (
    MSHV INT PRIMARY KEY,
    TENHV VARCHAR(255)
);

INSERT INTO HOCVI (MSHV, TENHV) VALUES
(1, 'KS'),
(2, 'CN'),
(3, 'Th.S'),
(4, 'TS'),
(5, 'TSKH');

CREATE TABLE CHUYENNGANH (
    MSCN INT PRIMARY KEY,
    TENCN VARCHAR(255)
);

INSERT INTO CHUYENNGANH (MSCN, TENCN) VALUES
(1, N'Hệ thống thông tin'),
(2, N'Mạng'),
(3, N'Đồ họa'),
(4, N'Công nghệ phần mềm');

CREATE TABLE GV_HV_CN (
    MSGV INT,
    MSHV INT,
    MSCN INT,
    NAM INT,
    FOREIGN KEY (MSGV) REFERENCES GIAOVIEN(MSGV),
    FOREIGN KEY (MSHV) REFERENCES HOCVI(MSHV),
    FOREIGN KEY (MSCN) REFERENCES CHUYENNGANH(MSCN)
);

INSERT INTO GV_HV_CN (MSGV, MSHV, MSCN, NAM) VALUES
(1, 1, 1, 1999),
(1, 1, 2, 1999),
(1, 2, 1, 1998),
(2, 3, 2, 1997),
(3, 2, 4, 1997),
(4, 3, 2, 1996);

CREATE TABLE HOCHAM (
    MSHH INT PRIMARY KEY,
    TENHH VARCHAR(255)
);

INSERT INTO HOCHAM (MSHH, TENHH) VALUES
(1, N'Phó giáo sư'),
(2, N'Giáo sư');

CREATE TABLE GV_HDDT (
    MSGV INT,
    MSDT VARCHAR(20),
    DIEM DECIMAL(4, 2),
    FOREIGN KEY (MSGV) REFERENCES GIAOVIEN(MSGV),
    FOREIGN KEY (MSDT) REFERENCES DETAI(MSDT)
);

INSERT INTO GV_HDDT (MSGV, MSDT, DIEM) VALUES
(1, 97001, 7),
(2, 97002, 8),
(5, 97003, 9),
(4, 97004, 8.5),
(3, 97005, 7);

CREATE TABLE GV_PBDT (
    MSGV INT,
    MSDT VARCHAR(20),
    DIEM DECIMAL(4, 2),
    FOREIGN KEY (MSGV) REFERENCES GIAOVIEN(MSGV),
    FOREIGN KEY (MSDT) REFERENCES DETAI(MSDT)
);

INSERT INTO GV_PBDT (MSGV, MSDT, DIEM) VALUES
(1, '97005', 5),
(2, '97001', 7),
(5, '97004', 6),
(4, '97003', 8.5),
(3, '97002', 9);

CREATE TABLE GV_UVDT (
    MSGV INT,
    MSDT VARCHAR(20),
    DIEM DECIMAL(4, 2),
    FOREIGN KEY (MSGV) REFERENCES GIAOVIEN(MSGV),
    FOREIGN KEY (MSDT) REFERENCES DETAI(MSDT)
);

INSERT INTO GV_UVDT (MSGV, MSDT, DIEM) VALUES
(5, '97005', 6),
(2, '97005', 5),
(4, '97005', 5),
(3, '97001', 7),
(4, '97001', 7),
(5, '97001', 8),
(3, '97003', 10),
(1, '97003', 7),
(2, '97003', 7),
(1, '97004', 8),
(2, '97004', 9),
(3, '97004', 5),
(1, '97002', 9),
(4, '97002', 9),
(5, '97002', 6);

CREATE TABLE HOIDONG (
    MSHD INT PRIMARY KEY,
    PHONG VARCHAR(10),
    TGBD TIME,
    NGAYHD DATE,
    TINHTRANG VARCHAR(20),
    MSGVCTHD INT,
    FOREIGN KEY (MSGVCTHD) REFERENCES GIAOVIEN(MSGV)
);

INSERT INTO HOIDONG (MSHD, PHONG, TGBD, NGAYHD, TINHTRANG, MSGVCTHD) VALUES
(1, '002', '07:00', '2001-10-30', N'Thật', 1),
(2, '102', '07:00', '2001-10-30', N'Thử', 2),
(3, '003', '08:00', '2001-10-31', N'Thật', 3),
(4, '103', '08:00', '2001-10-31', N'Thử', 4);

CREATE TABLE HOIDONG_GV (
    MSHD INT,
    MSGV INT,
    FOREIGN KEY (MSHD) REFERENCES HOIDONG(MSHD),
    FOREIGN KEY (MSGV) REFERENCES GIAOVIEN(MSGV)
);

INSERT INTO HOIDONG_GV (MSHD, MSGV) VALUES
(1, 1),
(1, 2),
(1, 3),
(1, 4),
(2, 3),
(2, 2),
(2, 5),
(2, 4),
(3, 1),
(3, 2),
(3, 3),
(3, 4),
(4, 3),
(4, 2),
(4, 5),
(4, 4);


CREATE TABLE HOIDONG_DT (
    MSHD INT,
    MSDT VARCHAR(20),
    QUYETDINH VARCHAR(10),
    FOREIGN KEY (MSHD) REFERENCES HOIDONG(MSHD),
    FOREIGN KEY (MSDT) REFERENCES DETAI(MSDT)
);

INSERT INTO HOIDONG_DT (MSHD, MSDT, QUYETDINH) VALUES
(1, '97001', N'Được'),
(1, '97002', N'Được'),
(2, '97003', N'Không'),
(2, '97004',N'Không'),
(1, '97005', N'Được'),
(3, '97001', N'Không'),
(3, '97002',  N'Được'),
(3, '97004', N'Không'),
(4, '97003', N'Không'),
(4, '97005', N'Không');


SELECT 
    DT.TENDT AS 'Tên Đề Tài',
    SV.TENSV AS 'Tên Sinh Viên Tham Gia',
    GVHD.TENGV AS 'Tên Giáo Viên Hướng Dẫn',
    GVPB.TENGV AS 'Tên Giáo Viên Phản Biện'
FROM 
    HOIDONG_DT HD_DT
INNER JOIN DETAI DT ON HD_DT.MSDT = DT.MSDT
INNER JOIN HOIDONG HD ON HD_DT.MSHD = HD.MSHD
INNER JOIN HOIDONG_GV HD_GV ON HD.MSHD = HD_GV.MSHD
INNER JOIN GIAOVIEN GVHD ON HD_GV.MSGV = GVHD.MSGV
LEFT JOIN GV_HDDT GV_PB ON HD.MSHD = GV_PB.MSGV
LEFT JOIN GIAOVIEN GVPB ON GV_PB.MSGV = GVPB.MSGV
LEFT JOIN SV_DETAI SV_DT ON DT.MSDT = SV_DT.MSDT
LEFT JOIN SINHVIEN SV ON SV_DT.MSSV = SV.MSSV;

SELECT GIAOVIEN.TENGV, DETAI.TENDT
FROM GIAOVIEN
JOIN GV_HDDT ON GIAOVIEN.MSGV = GV_HDDT.MSGV
JOIN DETAI ON GV_HDDT.MSDT = DETAI.MSDT;

SELECT GIAOVIEN.TENGV, DETAI.TENDT AS TenDeTaiPhanBien
FROM GIAOVIEN
JOIN HOIDONG_GV ON GIAOVIEN.MSGV = HOIDONG_GV.MSGV
JOIN HOIDONG_DT ON HOIDONG_GV.MSHD = HOIDONG_DT.MSHD
JOIN DETAI ON HOIDONG_DT.MSDT = DETAI.MSDT
WHERE HOIDONG_DT.QUYETDINH = 'Không';

SELECT HOIDONG.MSHD, DETAI.TENDT AS TenDeTai, HOIDONG_DT.QUYETDINH
FROM HOIDONG
JOIN HOIDONG_DT ON HOIDONG.MSHD = HOIDONG_DT.MSHD
JOIN DETAI ON HOIDONG_DT.MSDT = DETAI.MSDT
WHERE HOIDONG.PHONG LIKE '%03' AND HOIDONG_DT.QUYETDINH IN ('Thử', 'Không');

SELECT HOIDONG.MSHD, DETAI.TENDT AS TenDeTai, AVG(GV_HDDT.DIEM) AS DIEMTB
FROM HOIDONG
JOIN HOIDONG_DT ON HOIDONG.MSHD = HOIDONG_DT.MSHD
JOIN DETAI ON HOIDONG_DT.MSDT = DETAI.MSDT
JOIN GV_HDDT ON HOIDONG_DT.MSDT = GV_HDDT.MSDT
WHERE HOIDONG.TINHTRANG = 'Thật'
GROUP BY HOIDONG.MSHD, DETAI.TENDT;

SELECT DETAI.TENDT AS TenDeTai, SINHVIEN.TENSV AS TenSinhVien, 
       GIAOVIEN.TENGV AS TenGiaoVien, GV_HDDT.DIEM AS Diem
FROM DETAI
JOIN SV_DETAI ON DETAI.MSDT = SV_DETAI.MSDT
JOIN SINHVIEN ON SV_DETAI.MSSV = SINHVIEN.MSSV
JOIN GV_HDDT ON DETAI.MSDT = GV_HDDT.MSDT
JOIN GIAOVIEN ON GV_HDDT.MSGV = GIAOVIEN.MSGV;

SELECT HOIDONG.TGBD AS ThoiGian, HOIDONG.NGAYHD AS Ngay, 
       COUNT(HOIDONG_DT.MSDT) AS SoLuongDeTai, 
       GIAOVIEN.TENGV AS TenChuTich
FROM HOIDONG
JOIN GIAOVIEN ON HOIDONG.MSGVCTHD = GIAOVIEN.MSGV
LEFT JOIN HOIDONG_DT ON HOIDONG.MSHD = HOIDONG_DT.MSHD
GROUP BY HOIDONG.MSHD, HOIDONG.TGBD, HOIDONG.NGAYHD, GIAOVIEN.TENGV;

SELECT DISTINCT HOIDONG.MSHD, GIAOVIEN.TENGV AS TenGiaoVien, GIAOVIEN.SODT AS SoDienThoai
FROM HOIDONG
JOIN HOIDONG_GV ON HOIDONG.MSHD = HOIDONG_GV.MSHD
JOIN GIAOVIEN ON HOIDONG_GV.MSGV = GIAOVIEN.MSGV;

go
CREATE PROCEDURE InsertTeacherWithCheckHHam 
    @MSGV INT,
    @TENGV VARCHAR(100),
    @DIACHI VARCHAR(100),
    @SODT VARCHAR(15),
    @MSHHAM INT,
    @NAMHH INT
AS
BEGIN
    IF EXISTS (SELECT 1 FROM HOCHAM WHERE MSHH = @MSHHAM)
    BEGIN
        INSERT INTO GIAOVIEN (MSGV, TENGV, DIACHI, SODT, MSHHAM, NAMHH)
        VALUES (@MSGV, @TENGV, @DIACHI, @SODT, @MSHHAM, @NAMHH)
        SELECT 1 AS 'Result'
    END
    ELSE
    BEGIN
        SELECT 0 AS 'Result'
    END
END

go
CREATE PROCEDURE InsertTeacherWithCheckMSGV
    @MSGV INT,
    @TENGV VARCHAR(100),
    @DIACHI VARCHAR(100),
    @SODT VARCHAR(15),
    @MSHHAM INT,
    @NAMHH INT
AS
BEGIN
    IF NOT EXISTS (SELECT 1 FROM GIAOVIEN WHERE MSGV = @MSGV)
    BEGIN
        INSERT INTO GIAOVIEN (MSGV, TENGV, DIACHI, SODT, MSHHAM, NAMHH)
        VALUES (@MSGV, @TENGV, @DIACHI, @SODT, @MSHHAM, @NAMHH)
        SELECT 1 AS 'Result'
    END
    ELSE
    BEGIN
        SELECT 0 AS 'Result'
    END
END

go
CREATE PROCEDURE InsertTeacherWithCheckMSGVHHam
    @MSGV INT,
    @TENGV VARCHAR(100),
    @DIACHI VARCHAR(100),
    @SODT VARCHAR(15),
    @MSHHAM INT,
    @NAMHH INT
AS
BEGIN
    IF NOT EXISTS (SELECT 1 FROM GIAOVIEN WHERE MSGV = @MSGV)
    BEGIN
        IF EXISTS (SELECT 1 FROM HOCHAM WHERE MSHH = @MSHHAM)
        BEGIN
            INSERT INTO GIAOVIEN (MSGV, TENGV, DIACHI, SODT, MSHHAM, NAMHH)
            VALUES (@MSGV, @TENGV, @DIACHI, @SODT, @MSHHAM, @NAMHH)
            SELECT 1 AS 'Result'
        END
        ELSE
        BEGIN
            SELECT 0 AS 'Result'
        END
    END
    ELSE
    BEGIN
        SELECT 0 AS 'Result'
    END
END

go
CREATE PROCEDURE UpdateTenDeTai
    @MSDT VARCHAR(20),
    @TENDETAI_NEW NVARCHAR(150)
AS
BEGIN
    IF EXISTS (SELECT 1 FROM DETAI WHERE MSDT = @MSDT)
    BEGIN
        UPDATE DETAI SET TENDT = @TENDETAI_NEW WHERE MSDT = @MSDT
        SELECT 1 AS 'Result'
    END
    ELSE
    BEGIN
        SELECT 0 AS 'Result'
    END
END

go
CREATE PROCEDURE UpdateStudent
    @MSSV VARCHAR(20),
    @TENSV_NEW NVARCHAR(150),
    @DIACHI_NEW NVARCHAR(100)
AS
BEGIN
    IF EXISTS (SELECT 1 FROM SINHVIEN WHERE MSSV = @MSSV)
    BEGIN
        UPDATE SINHVIEN SET TENSV = @TENSV_NEW, DIACHI = @DIACHI_NEW WHERE MSSV = @MSSV
        SELECT 1 AS 'Result'
    END
    ELSE
    BEGIN
        SELECT 0 AS 'Result'
    END
END

go
CREATE PROCEDURE SwapTeachersForDeTai
    @MSDT VARCHAR(20)
AS
BEGIN
    IF EXISTS (SELECT 1 FROM DETAI WHERE MSDT = @MSDT)
    BEGIN
        UPDATE GV_HDDT
        SET MSGV = CASE WHEN MSGV IN (SELECT MSGV FROM GV_HDDT WHERE MSDT = @MSDT AND DIEM > 5) THEN 
                           (SELECT MSGV FROM GV_PBDT WHERE MSDT = @MSDT)
                       ELSE
                           (SELECT MSGV FROM GV_HDDT WHERE MSDT = @MSDT)
                  END
        WHERE MSDT = @MSDT
        SELECT 1 AS 'Result'
    END
    ELSE
    BEGIN
        SELECT 0 AS 'Result'
    END
END

go
CREATE PROCEDURE TransferDeTaiForNewTeacher
    @TENGV NVARCHAR(100),
    @TENSV NVARCHAR(150)
AS
BEGIN
    DECLARE @MSGV_NEW INT, @MSSV VARCHAR(20), @MSDT VARCHAR(20)

    -- Lấy MSGV của giáo viên mới từ tên giáo viên đầu vào
    SELECT @MSGV_NEW = MSGV FROM GIAOVIEN WHERE TENGV = @TENGV

    -- Lấy MSSV của sinh viên từ tên sinh viên đầu vào
    SELECT @MSSV = MSSV FROM SINHVIEN WHERE TENSV = @TENSV

    -- Kiểm tra xem MSGV của giáo viên mới và MSSV của sinh viên đã tồn tại không
    IF @MSGV_NEW IS NOT NULL AND @MSSV IS NOT NULL
    BEGIN
        -- Lấy MSDT của đề tài mà sinh viên đó tham gia
        SELECT @MSDT = MSDT FROM SV_DETAI WHERE MSSV = @MSSV

        -- Kiểm tra xem sinh viên đó đã tham gia một đề tài nào đó chưa
        IF @MSDT IS NOT NULL
        BEGIN
            -- Cập nhật MSGV mới cho đề tài của sinh viên đó
            UPDATE GV_HDDT 
            SET MSGV = @MSGV_NEW 
            WHERE MSDT = @MSDT AND MSGV IN (SELECT MSGV FROM GV_HDDT WHERE MSDT = @MSDT AND DIEM > 5)

            -- Trả về kết quả thành công
            SELECT 1 AS 'Result'
        END
        ELSE
        BEGIN
            -- Trả về kết quả không thành công vì sinh viên chưa tham gia đề tài nào
            SELECT 0 AS 'Result'
        END
    END
    ELSE
    BEGIN
        -- Trả về kết quả không thành công vì không tìm thấy MSGV mới hoặc MSSV
        SELECT 0 AS 'Result'
    END
END





go
CREATE PROCEDURE DeleteStudentIfConstraintNotViolated
    @TENSV NVARCHAR(150)
AS
BEGIN
    DECLARE @MSSV VARCHAR(20)

    SELECT @MSSV = MSSV FROM SINHVIEN WHERE TENSV = @TENSV

    IF @MSSV IS NOT NULL
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM SV_DETAI WHERE MSSV = @MSSV)
        BEGIN
            DELETE FROM SINHVIEN WHERE MSSV = @MSSV
            SELECT 1 AS 'Result'
        END
        ELSE
        BEGIN
            SELECT 0 AS 'Result'
        END
    END
    ELSE
    BEGIN
        SELECT 0 AS 'Result'
    END
END

go
CREATE PROCEDURE CountTeachersByAcademicDegree
    @TENHV NVARCHAR(255),
    @TotalTeachers INT OUTPUT
AS

BEGIN
    SELECT @TotalTeachers = COUNT(*) 
    FROM GV_HV_CN GH 
    INNER JOIN HOCVI HV ON GH.MSHV = HV.MSHV 
    WHERE HV.TENHV = @TENHV

    IF @TotalTeachers > 0
        SELECT @TotalTeachers AS 'TotalTeachers'
    ELSE
        SELECT 0 AS 'TotalTeachers'
END

go
CREATE PROCEDURE CalculateAverageScoreForDeTai
    @MSDT VARCHAR(20),
    @AverageScore DECIMAL(4, 2) OUTPUT
AS
BEGIN
    SELECT @AverageScore = AVG(DIEM) 
    FROM GV_HDDT 
    WHERE MSDT = @MSDT

    IF @AverageScore IS NOT NULL
        SELECT @AverageScore AS 'AverageScore'
    ELSE
        SELECT 0 AS 'AverageScore'
END

go
CREATE PROCEDURE GetPhoneNumberByTeacherName
    @TENGV NVARCHAR(100),
    @PhoneNumber VARCHAR(15) OUTPUT
AS
BEGIN
    SELECT @PhoneNumber = SODT 
    FROM GIAOVIEN 
    WHERE TENGV = @TENGV

    IF @PhoneNumber IS NOT NULL
        SELECT @PhoneNumber AS 'PhoneNumber'
    ELSE
        SELECT 0 AS 'PhoneNumber'
END

go
CREATE PROCEDURE GetChairmanInfoByMSHD
    @MSHD INT,
    @ChairmanName NVARCHAR(100) OUTPUT,
    @ChairmanPhoneNumber VARCHAR(15) OUTPUT
AS
BEGIN
    SELECT @ChairmanName = TENGV, @ChairmanPhoneNumber = SODT 
    FROM GIAOVIEN GV
    INNER JOIN HOIDONG HD ON GV.MSGV = HD.MSGVCTHD
    WHERE HD.MSHD = @MSHD

    IF @ChairmanName IS NOT NULL AND @ChairmanPhoneNumber IS NOT NULL
        SELECT @ChairmanName AS 'ChairmanName', @ChairmanPhoneNumber AS 'ChairmanPhoneNumber'
    ELSE
        SELECT 0 AS 'ChairmanName', 0 AS 'ChairmanPhoneNumber'
END

go
CREATE PROCEDURE GetNumberOfDeTaiByTeacherName
    @TENGV NVARCHAR(100),
    @DeTaiHuongDan INT OUTPUT,
    @DeTaiPhanBien INT OUTPUT
AS
BEGIN
    SELECT @DeTaiHuongDan = COUNT(GH.MSGV), @DeTaiPhanBien = COUNT(GP.MSGV)
    FROM GV_HDDT GH
    LEFT JOIN GV_PBDT GP ON GH.MSGV = GP.MSGV
    INNER JOIN GIAOVIEN GV ON GH.MSGV = GV.MSGV
    WHERE GV.TENGV = @TENGV

    IF @DeTaiHuongDan IS NOT NULL AND @DeTaiPhanBien IS NOT NULL
        SELECT @DeTaiHuongDan AS 'DeTaiHuongDan', @DeTaiPhanBien AS 'DeTaiPhanBien'
    ELSE
        SELECT 0 AS 'DeTaiHuongDan', 0 AS 'DeTaiPhanBien'
END


